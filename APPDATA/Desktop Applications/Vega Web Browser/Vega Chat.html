<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vega Secure Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase components
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: We now explicitly import getDocs to fetch all documents for in-memory sorting.
        import { getFirestore, collection, query, limit, addDoc, onSnapshot, serverTimestamp, setLogLevel, doc, getDocs, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentUsername = null; // New state for the required Vega Account name

        const mainContent = document.getElementById('main-content');
        const chatContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const deletedOverlay = document.getElementById('account-deleted-overlay');
        const setupOverlay = document.getElementById('account-setup-overlay');
        const setupInput = document.getElementById('account-setup-input');
        const publicDataPath = `/artifacts/${appId}/public/data/messages`;
        
        // Private path for user metadata (requires authenticated user)
        const privateProfilePath = (uid) => `/artifacts/${appId}/users/${uid}/profile/account`;

        // 1. Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) throw new Error("Firebase config not available.");
                setLogLevel('Debug');

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Gating: Hide main content until username is confirmed
                mainContent.classList.add('hidden');

                // Authenticate using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for Auth State Changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        loadUserProfile(); // Check if user has set a Vega Account name
                        deletedOverlay.classList.add('hidden');
                    } else {
                        userIdDisplay.textContent = 'User ID: N/A (Signing in...)';
                        isAuthReady = false;
                        mainContent.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication Failed:", error);
                userIdDisplay.textContent = `Error: ${error.message}`;
                showAccountDeletedScreen(); // Use deleted screen for critical failures
            }
        }

        // 2. Load User Profile (Vega Account Name)
        async function loadUserProfile() {
            if (!isAuthReady || !userId) return;

            const profileRef = doc(db, privateProfilePath(userId));
            try {
                const docSnap = await getDoc(profileRef);

                if (docSnap.exists() && docSnap.data().username) {
                    // User has a Vega Account name set
                    currentUsername = docSnap.data().username;
                    setupOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden'); // Show chat
                    startChatListener();
                } else {
                    // User needs to create a Vega Account name
                    showAccountSetupScreen();
                }
            } catch (error) {
                console.error("Error loading profile:", error);
                // Fallback: If profile loading fails (e.g., permission error), still prompt for setup
                showAccountSetupScreen();
            }
        }

        // 3. Set Vega Account Name
        async function setAccount() {
            const username = setupInput.value.trim();
            if (username.length < 3) {
                alert("Username must be at least 3 characters long."); // Using custom alert for best practice
                return;
            }

            if (!isAuthReady || !userId) {
                console.error("Cannot set account: User not authenticated.");
                return;
            }

            const profileRef = doc(db, privateProfilePath(userId));
            try {
                // Save the new username to the private profile document
                await setDoc(profileRef, {
                    username: username,
                    createdAt: serverTimestamp()
                });
                
                // Success: Update state and unlock chat
                currentUsername = username;
                setupOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
                startChatListener();

            } catch (error) {
                console.error("Error setting account name:", error);
                alert("Failed to save account. Please try again.");
            }
        }

        // 4. Real-time Chat Listener
        function startChatListener() {
            if (!isAuthReady || !db || !currentUsername) return;
            
            // Set up listener
            const messagesRef = collection(db, publicDataPath);
            
            onSnapshot(messagesRef, (snapshot) => {
                let messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort messages by timestamp in JavaScript memory (Ascending)
                messages.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeA - timeB; // Ascending sort
                });

                // Apply limit in memory
                const limitedMessages = messages.slice(-50);

                renderMessages(limitedMessages);
            }, (error) => {
                console.error("Error listening to messages:", error);
                chatContainer.innerHTML = '<div class="text-center text-red-500 pt-12">Error loading chat: Check console for details.</div>';
            });
        }

        // 5. Render Messages to UI
        function renderMessages(messages) {
            chatContainer.innerHTML = ''; // Clear existing messages
            messages.forEach(msg => {
                const senderName = msg.username || msg.userId || 'Unknown User';
                const isCurrentUser = msg.userId === userId;
                const alignment = isCurrentUser ? 'justify-end' : 'justify-start';
                const bgColor = isCurrentUser ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800';
                const avatarColor = isCurrentUser ? 'bg-indigo-800' : 'bg-gray-400';
                const timeStr = msg.timestamp && msg.timestamp.seconds ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString() : '...';

                const messageHtml = `
                    <div class="flex ${alignment} mb-4">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg flex items-start space-x-2">
                            ${!isCurrentUser ? `
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold ${avatarColor} text-white flex-shrink-0" title="User ID: ${msg.userId}">
                                    ${senderName.substring(0, 2)}
                                </div>
                            ` : ''}
                            <div class="flex flex-col">
                                <span class="text-xs ${isCurrentUser ? 'text-gray-400 text-right' : 'text-gray-600 text-left'} mb-1 font-mono">${senderName}</span>
                                <div class="p-4 rounded-xl ${bgColor} shadow-md break-words">
                                    <p class="text-sm">${msg.text}</p>
                                </div>
                                <span class="text-xs ${isCurrentUser ? 'text-gray-400 text-right' : 'text-gray-400 text-left'} mt-1">${timeStr}</span>
                            </div>
                            ${isCurrentUser ? `
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold ${avatarColor} text-white flex-shrink-0" title="You">
                                    ${senderName.substring(0, 2)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 6. Send Message Function
        async function sendMessage() {
            const text = messageInput.value.trim();

            if (!isAuthReady || !userId || !currentUsername) {
                console.error("Cannot send message: Vega Account not set or user not authenticated.");
                showAccountSetupScreen();
                return;
            }

            if (text.length > 0) {
                try {
                    await addDoc(collection(db, publicDataPath), {
                        userId: userId,
                        username: currentUsername, // Include the Vega Account name
                        text: text,
                        timestamp: serverTimestamp()
                    });
                    messageInput.value = '';
                    messageInput.focus();
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }
        }

        // 7. Account Setup Screen Logic
        function showAccountSetupScreen() {
            setupOverlay.classList.remove('hidden');
            setupInput.focus();
        }

        // 8. Account Deleted Screen/Modal Logic
        function showAccountDeletedScreen() {
            deletedOverlay.classList.remove('hidden');
        }

        function hideAccountDeletedScreen() {
             deletedOverlay.classList.add('hidden');
        }
        
        // 9. Event Listeners
        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        document.getElementById('simulate-delete').addEventListener('click', showAccountDeletedScreen);
        document.getElementById('simulate-restore').addEventListener('click', hideAccountDeletedScreen);
        
        document.getElementById('setup-button').addEventListener('click', setAccount);
        setupInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                setAccount();
            }
        });


        // Start the application
        window.onload = initializeFirebase;
    </script>
</head>
<body class="bg-gray-100 h-screen flex flex-col antialiased">

    <!-- Main Chat Window (Initially Hidden) -->
    <div id="main-content" class="flex-grow flex flex-col p-4 md:p-8 hidden">
        <header class="bg-white p-4 rounded-t-2xl shadow-md flex justify-between items-center flex-wrap gap-2">
            <h1 class="text-3xl font-bold text-indigo-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.228-1.008 1.498 1.498 0 00-.746-.075 2.38 2.38 0 01-.586.084 1.83 1.83 0 00-.472.084l-.178.043 2.14 2.14A1 1 0 0011 18h2a1 1 0 001-1v-2h3a1 1 0 001-1V9a1 1 0 00-1-1h-3V5a1 1 0 00-1-1H9a1 1 0 00-1 1v3H5a1 1 0 00-1 1v4a1 1 0 001 1h3v2a1 1 0 001 1h2a1 1 0 00.707-.293l2.5-2.5A1 1 0 0018 10z" clip-rule="evenodd" />
                </svg>
                Vega Secure Chatroom
            </h1>
            <div id="user-info" class="flex items-center space-x-4">
                <span id="user-id-display" class="text-sm font-mono text-gray-500 bg-gray-50 p-2 rounded-full shadow-inner">User ID: N/A</span>
                <button id="simulate-delete" class="px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-full hover:bg-red-600 transition duration-150 shadow-lg">
                    Simulate Account Delete
                </button>
                <button id="simulate-restore" class="px-4 py-2 bg-green-500 text-white text-sm font-medium rounded-full hover:bg-green-600 transition duration-150 shadow-lg">
                    Restore Chat Access
                </button>
            </div>
        </header>

        <!-- Message History Area -->
        <main id="chat-messages" class="flex-grow bg-white p-6 overflow-y-auto rounded-b-xl shadow-inner border-t border-gray-200" style="height: 0;">
            <!-- Messages load here -->
            <div class="text-center text-gray-400 pt-12">Loading messages...</div>
        </main>

        <!-- Message Input Area -->
        <footer class="mt-4 bg-white p-4 rounded-xl shadow-2xl">
            <div class="flex items-center space-x-4">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your secure message here..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                    maxlength="500"
                >
                <button
                    id="send-message-button"
                    class="p-3 bg-indigo-500 text-white rounded-lg shadow-lg hover:bg-indigo-600 transition duration-150 flex items-center justify-center disabled:opacity-50"
                    title="Send Message"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.493-.162 4.414-1.637a1 1 0 00.586-.94v-3.82a1 1 0 011.894 0v3.82a1 1 0 00.586.94l4.414 1.637.493.162a1 1 0 001.17-1.409l-7-14z" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <!-- 10. Account Setup Overlay (New Requirement) -->
    <div id="account-setup-overlay" class="fixed inset-0 bg-indigo-900 bg-opacity-95 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full text-center border-4 border-indigo-500 transform transition-all duration-300 scale-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            <h2 class="text-3xl font-extrabold text-indigo-600 mb-4">
                Create Your Vega Account
            </h2>
            <p class="text-lg text-gray-700 mb-6">
                Please choose a unique username. This is your Vega identity.
            </p>
            <input 
                type="text" 
                id="account-setup-input" 
                placeholder="Enter Username (e.g., SecureUser1)"
                class="w-full p-3 mb-6 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
            >
            <button 
                id="setup-button" 
                class="px-6 py-3 bg-indigo-500 text-white font-semibold rounded-full hover:bg-indigo-600 transition duration-150 shadow-md w-full"
            >
                Confirm Account Name
            </button>
        </div>
    </div>

    <!-- 11. Account Deleted Screen Overlay (Existing Requirement) -->
    <div id="account-deleted-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-lg w-full text-center border-4 border-red-500 transform transition-all duration-300 scale-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-6 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 001 1h2a1 1 0 100-2h-1V6z" clip-rule="evenodd" />
            </svg>
            <h2 class="text-3xl font-extrabold text-red-600 mb-4">
                Account Access Revoked
            </h2>
            <p class="text-lg text-gray-700 mb-8">
                This account has been successfully deleted or access has been disabled. All personal data related to this user profile has been purged in accordance with Vega's security policy.
            </p>
            <p class="text-sm text-gray-500 mb-6">
                To regain access, please contact support or create a new user profile.
            </p>
            <button onclick="window.location.reload()" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition duration-150 shadow-md">
                Reload Application
            </button>
        </div>
    </div>
</body>
</html>